#!/bin/bash

if [ -z "$BASE_DIR" ]; then
	BASE_DIR="$(pwd)/buildmaster"
	echo "WARNING: BASE_DIR is currently undefined. Assuming $BASE_DIR."
fi

if [ -z "$HAIKUPORTER" ]
then
	HAIKUPORTER=$(which haikuporter 2>/dev/null)
	if [ $? -ne 0 ]; then
		echo "ERROR: HAIKUPORTER environment variable not set and haikuporter not in path"
		exit 1
	fi
fi

HAIKUPORTS_TREE="$(${HAIKUPORTER} -t)"

case "$1" in
	update)
		git -C "${HAIKUPORTS_TREE}" pull --ff-only
		if [ $? -ne 0 ]
		then
			echo "git pull failed, manual fixing needed"
			exit 2
		fi

		REVISIONS_FILE="$BASE_DIR/processed_rev"
		PREVIOUS_REVISION=$(cat "$REVISIONS_FILE" 2>/dev/null)
		HEAD_REVISION=$(git -C "${HAIKUPORTS_TREE}" rev-parse HEAD)

		if [ "$PREVIOUS_REVISION" == "$HEAD_REVISION" ]
		then
			echo "no new revisions"
			exit 3
		fi

		echo "moving from $PREVIOUS_REVISION to $HEAD_REVISION"
		"$HAIKUPORTER" --no-package-obsoletion --repository-update

		PORTS_TO_BUILD=$(git -C "${HAIKUPORTS_TREE}" diff-tree -z -r --name-only \
				--diff-filter ACMTR $PREVIOUS_REVISION..$HEAD_REVISION \
			| xargs --null "$HAIKUPORTER" --no-package-obsoletion \
				--no-repository-update --ports-for-files \
				--active-versions-only 2> /dev/null \
			| sort -u)

		if [ -z "$PORTS_TO_BUILD" ]
		then
			echo "no ports changed"
			echo "$HEAD_REVISION" > "$REVISIONS_FILE"
			exit 3
		fi
	;;
	everything)
		PORTS_TO_BUILD=$("$HAIKUPORTER" --no-package-obsoletion --print-raw \
			--list 2> /dev/null)
	;;
	build)
		PORTS_TO_BUILD="${@:2}"
	;;
	*)
		cat <<EOF
usage: $0 <mode> [<args>]

Where mode can be one of the following modes:

	update
		Fetch the git repository and make a buildrun for all recipes
		that were added/changed since the last update.

	everything
		Make a buildrun to build all current ports (this takes a while).

	build <ports>
		Make a buildrun to build the specified ports.

EOF
		exit 1
	;;
esac

if [ -z "$PORTS_TO_BUILD" ]
then
	echo "no ports to build specified"
	exit 2
fi

echo "ports to be built: $PORTS_TO_BUILD"

BUILDRUN_FILE="$BASE_DIR/buildruns/last_buildrun"
BUILDRUN=$(expr $(cat "$BUILDRUN_FILE" 2> /dev/null) + 1)
BUILDRUN_OUTPUT_DIR="$BASE_DIR/buildruns/$BUILDRUN"
BUILDRUN_INDEX="$BASE_DIR/buildruns/buildruns.txt"

echo "$BUILDRUN" >> "$BUILDRUN_INDEX"
echo "$BUILDRUN" > "$BUILDRUN_FILE"

# Remove and relink the current output dir.
rm "$BASE_DIR/output"
ln -rs "$BUILDRUN_OUTPUT_DIR/output" "$BASE_DIR"

"$HAIKUPORTER" --debug --build-master-output-dir="$BUILDRUN_OUTPUT_DIR" \
	--all-dependencies --build-master $PORTS_TO_BUILD

if [ $? -ne 0 ]
then
	echo "build master failed"
	exit 3
fi

case "$1" in
	update)
		echo "$HEAD_REVISION" > "$REVISIONS_FILE"
	;;
esac
